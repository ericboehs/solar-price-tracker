#!/usr/bin/env bash
# frozen_string_literal: true

set -e

# Check if --fix flag is passed
if [ "$1" = "--fix" ]; then
  echo "ğŸ”§ Running fixes..."
  echo

  echo "ğŸ“ Fixing file formatting..."
  npx eclint fix 'app/**/*' 'config/**/*' 'lib/**/*' 'test/**/*' 'bin/*' 'Gemfile*' 'Rakefile' '*.rb' '*.yml' '*.yaml' '*.js' '*.css' '*.html' '*.erb' '*.md'
  echo "âœ… eclint fix completed"
  echo

  echo "ğŸ” Auto-fixing rubocop violations..."
  rubocop -A
  echo "âœ… rubocop auto-fix completed"
  echo

  echo "ğŸ‰ All fixes applied! Continuing with CI pipeline..."
  echo
fi

echo "ğŸš€ Running CI pipeline..."
echo

echo "ğŸ“ Running eclint check..."
npx eclint check 'app/**/*' 'config/**/*' 'lib/**/*' 'test/**/*' 'bin/*' 'Gemfile*' 'Rakefile' '*.rb' '*.yml' '*.yaml' '*.js' '*.css' '*.html' '*.erb' '*.md'
echo "âœ… eclint check passed"
echo

echo "ğŸ” Running rubocop..."
rubocop
echo "âœ… rubocop passed"
echo

echo "ğŸ›¡ï¸  Running brakeman security scan..."
brakeman --no-pager --quiet
echo "âœ… brakeman security scan passed"
echo

echo "ğŸ§ª Running tests..."
rails test
echo "âœ… tests passed"
echo

echo "ğŸ§ª Running system tests..."
rails test:system
echo "âœ… system tests passed"
echo

echo "ğŸ‰ All CI checks passed!"
